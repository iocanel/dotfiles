#!/usr/bin/env bash
set -e

# Check arguments
if [[ $# -ne 2 ]]; then
    echo "Usage: setup-work-vpn <path-to-ovpn-file> <username>"
    echo "Example: setup-work-vpn /path/to/config.ovpn canelio"
    exit 1
fi

VPN_CONFIG="$1"
USERNAME="$2"
CONNECTION_NAME="work-vpn"

echo "Setting up NetworkManager VPN connection..."
echo "Config file: $VPN_CONFIG"
echo "Username: $USERNAME"
echo "Connection name: $CONNECTION_NAME"

# Check if config file exists
if [[ ! -f "$VPN_CONFIG" ]]; then
    echo "Error: VPN config file not found at $VPN_CONFIG"
    exit 1
fi

# Delete existing connection if it exists
if nmcli connection show "$CONNECTION_NAME" &>/dev/null; then
    echo "Deleting existing connection '$CONNECTION_NAME'..."
    nmcli connection delete "$CONNECTION_NAME"
fi

# Import the VPN configuration
echo "Importing VPN configuration..."
IMPORTED_NAME=$(basename "$VPN_CONFIG" .ovpn)
nmcli connection import type openvpn file "$VPN_CONFIG"

# Rename to work-vpn if different
if [[ "$IMPORTED_NAME" != "$CONNECTION_NAME" ]]; then
    echo "Renaming connection from '$IMPORTED_NAME' to '$CONNECTION_NAME'..."
    nmcli connection modify "$IMPORTED_NAME" connection.id "$CONNECTION_NAME"
fi

# Set the username and configure password saving
echo "Setting username to '$USERNAME'..."
nmcli connection modify "$CONNECTION_NAME" vpn.user-name "$USERNAME"

# Configure connection to save passwords for user
echo "Configuring connection to save credentials..."
nmcli connection modify "$CONNECTION_NAME" connection.permissions user:$USER

# Configure password storage - set password-flags to 0 (save in keyring)
echo "Enabling password storage in keyring..."
nmcli connection modify "$CONNECTION_NAME" +vpn.data password-flags=0

echo "VPN setup complete!"
echo
echo "Attempting to connect to save credentials..."
echo "Note: Please enter your password when prompted."
read -s -p "VPN Password: " VPN_PASSWORD
echo

# Save the password in the connection
echo "Saving password to connection..."
nmcli connection modify "$CONNECTION_NAME" +vpn.secrets "password=$VPN_PASSWORD"

echo "Testing connection with saved password..."
if nmcli connection up "$CONNECTION_NAME"; then
    echo "✓ VPN connected successfully!"
    
    # Verify password was saved by checking if we can disconnect and reconnect without prompting
    echo "Testing credential saving..."
    nmcli connection down "$CONNECTION_NAME" 2>/dev/null || true
    sleep 2
    
    if nmcli connection up "$CONNECTION_NAME" 2>/dev/null; then
        echo "✓ Credentials saved successfully! Future connections won't require password."
    else
        echo "⚠ Password may not have been saved. You may be prompted again next time."
        nmcli --ask connection up "$CONNECTION_NAME"
    fi
    
    echo
    echo "Usage:"
    echo "  Connect:    nmcli connection up $CONNECTION_NAME"
    echo "  Disconnect: nmcli connection down $CONNECTION_NAME"
    echo "  Status:     nmcli connection show $CONNECTION_NAME"
else
    echo "✗ Initial connection failed. Please try manually:"
    echo "nmcli --ask connection up $CONNECTION_NAME"
    echo
    echo "If the connection succeeds, the password should be saved automatically."
fi

